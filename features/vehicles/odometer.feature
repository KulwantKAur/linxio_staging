Feature: Odometer

  Scenario: I want to create vehicle odometer
    Given I signed in as "super_admin" team "admin"
    Then I want fill "model" field with 2
    Then I want fill "type" field with "Car"
    Then I want fill "vin" field with 4
    Then I want fill "fuelType" field with 1
    Then I want fill "year" field with "2000"
    And I want get client by name "client-name-0" and save id
    And I want fill teamId by saved clientId
    Then I want to create vehicle and save id
    And response code is 200
    And I see field "team/type" filled with "client"
    And I want fill device model for vehicle with name "FM3001"
    And I want fill "sn" field with "test sn"
    And I want fill "status" field with "inStock"
    And I want fill "port" field with 25
    And I want fill "imei" field with "888888888888888"
    And I want fill "phone" field with "+(375) 245535454"
    Then I want to create device for vehicle and save id
    Then I want install device for vehicle
    And I want set vehicle driver with user of current team with date "2019-05-29 08:19:38"
    Given There are following tracker payload from teltonika tracker with socket "that socket":
      | payload                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
      | 000F383838383838383838383838383838                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
      | 000000000000044f080b0000016f21e158700010647357201fe8f600ea00ee0e0056001507ef01f001c800710021fe2559302f0942388b1800564300004400000d06b30f00282a02552b0000311f3804f100006465c7000008b5100069440e0c00113c8801ee00000000000000000000016f21e16bf80010643ae5201fd45300ef00ef0d004f001507ef01f001c800710021002552302f094238a218004f4300004400000d06b30f00282a02592b0000311f3804f100006465c70000092710006944800c00113c9d01ee00000000000000000000016f21e177b00010641afe201fc80500f200ee0e0048001507ef01f001c800710021012551302f094238551800484300004400000d06b30f00282a025c2b0000311f3804f100006465c70000096910006944c20c00113ca901ee00000000000000000000016f21e17f80001064083e201fc0fd00f400ee0f003e001507ef01f001c800710021012551302f0942383518003e4300004400000d06b30f00282a025c2b0000311f3804f100006465c70000099110006944ea0c00113caf01ee00000000000000000000016f21e18750001063f9a9201fbc1b00f300ed0f002c001507ef01f001c800710021002542302f094237ee18002c4300004400000d06b30f00282a02602b0000311f3804f100006465c7000009b2100069450b0c00113cb401ee00000000000000000000016f21e18b38001063f5b0201fba5900f300ec0f0022001507ef01f001c800710021002542302f094236b01800224300004400000d06b30f00282a02602b0000311f3804f100006465c7000009bf10006945180c00113cb601ee00000000000000000000016f21e18f20001063f39b201fb99100f300e70e0012001507ef01f001c800710021002542302f0942378c1800124300004400000d06b30f00282a02602b0000311f3804f100006465c7000009c710006945200c00113cb601ee00000000000000000000016f21e19308001063f442201fb99100f200e70e0005001507ef01f001c80071002100251a302f094237ea1800054300004400000d06b30f00282a02642b0000311f3804f100006465c7000009cb10006945240c00113cb601ee00000000000000000000016f21e20838001063f678201fb9f500f300e70e0000001507ef01f001c800710021022500302f094237f61800004300004400000d06b30f00282a02822b0000311f3804f100006465c7000009cc10006945250c00113cbe01ee00000000000000000000016f21e27d68001063f678201fb9f500f300e70e0000001507ef01f001c800710021002500302f094237f61800004300004400000d06b30f00282a02a02b0000311f3804f100006465c7000009cc10006945250c00113cc701ee00000000000000000000016f21e298c0001063f678201fb9f500f300e70d0000f01507ef01f000c800710021fe2500302f094237df1800004300004400000d06b30f00282a02a72b0000311f3804f100006465c7000009cc10006945250c00113cc901ee00000000000000000b0000bc94 |
    Then I want fill "odometer" field with 6900000
    Then I want fill "occurredAt" field with "2019-12-20T06:00:00+00:00"
    Then I want to create odometer record and save id
    And response code is 200
    And I see field "odometer" filled with 6900000
    And I see field "accuracy" filled with 1019
    And I see field "occurredAt" filled with "2019-12-20T06:00:00+00:00"
    And I see field "lastTrackerRecordOccurredAt" filled with "2019-12-20T05:58:16+00:00"
    And I see field "lastTrackerRecordOdometer" filled with 6898981
    When I want to get vehicle odometer history
    And I see field "data/0/odometer" filled with 6900000
    And I see field "data/0/accuracy" filled with 1019
    And I see field "data/0/lastTrackerRecordOdometer" filled with 6898981
    Given There are following tracker payload from teltonika tracker with socket "that socket":
      | payload                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
      | 000F383838383838383838383838383838                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
      | 0000000000000422080b0000016f21e7b94000105c6f31201e4b4a00fd01020e0018001507ef01f001c80071002100251b302d0942387a1800184300004400000d06b30f00362a03f82b0000311f3c04f100006465c700001814100069536d0c00113ed501ee00000000000000000000016f21e7bd2800105c6bf0201e4c2300fd01170e0013001507ef01f001c80071002100251b302d0942387a1800134300004400000d06b30f00362a03f82b0000311f3c04f100006465c700001814100069536d0c00113ed501ee00000000000000000000016f21e7c8e000105c6c43201e525200fa001a0e0013001507ef01f001c80071002100251b302d094238dd1800134300004400000d06b30f00362a03f82b0000311f3c04f100006465c700001826100069537f0c00113ed601ee00000000000000000000016f21e7ccc800105c7167201e558300fa002b0e001f001507ef01f001c800710021f9251b302d0942392918001f4300004400000d06b30f00362a03fc2b0000311f3c04f100006465c70000182f10006953880c00113ed601ee00000000000000000000016f21e7d49800105c7786201e5ada00fa00190e001c001507ef01f001c800710021f9251b302d0942391018001c4300004400000d06b30f00362a03fc2b0000311f3c04f100006465c700001845100069539e0c00113ed801ee00000000000000000000016f21e7d88000105c799c201e5d9500fa000e0e001c001507ef01f001c800710021fd251d302d0942389618001c4300004400000d06b30f00362a04002b0000311f3c04f100006465c70000184e10006953a70c00113ed801ee00000000000000000000016f21e7e05000105c79de201e619f00fa01620e000f001507ef01f001c800710021fd251d302d0942381218000f4300004400000d06b30f00362a04002b0000311f3c04f100006465c70000185d10006953b60c00113ed901ee00000000000000000000016f21e7e43800105c7938201e628800fa01550e0007001507ef01f001c800710021fd251d302d0942384b1800074300004400000d06b30f00362a04002b0000311f3c04f100006465c70000186210006953bb0c00113ed901ee00000000000000000000016f21e82e7000105c78d4201e62cb00fa01550d0000ef0f04ef00f001c8007100064233841800004300004400000d06b30f003604f100006465c70000186510006953be0c00113edd01ee00000000000000000000016f21e8a3a000105c78d4201e62cb00fa01550e0000000f04ef00f001c8007100064233021800004300004400000d06b30f003604f100006465c70000186510006953be0c00113edd01ee00000000000000000000016f21e8edd800105c78d4201e62cb00fa01550d0000f00f04ef00f000c8007100064232d41800004300004400000d06b30f003604f100006465c70000186510006953be0c00113edd01ee00000000000000000b00005d76                                                                                                                                                                                                                                                                                                   |
    When I want to get vehicle current odometer
    # 6902718+1019
    And I see field "odometer" filled with 6903737
    And I see field "accuracy" filled with 1019
    And I see field "occurredAt" filled with "2019-12-20T06:00:00+00:00"
    And I see field "lastTrackerRecordOccurredAt" filled with "2019-12-20T06:05:11+00:00"
    And I see field "lastTrackerRecordOdometer" filled with 6902718
    Then I want fill "odometer" field with 6904000
    Then I want fill "occurredAt" field with "2019-12-20T06:01:00+00:00"
    Then I want to create odometer record and save id
    Then I want fill "occurredAt" field with "2019-12-20T06:00:59%2B00:00"
    When I want to get vehicle odometer by date
    And I see field "odometer" filled with 6900000
    And I see field "accuracy" filled with 1019
    And I see field "occurredAt" filled with "2019-12-20T06:00:00+00:00"
    And I see field "lastTrackerRecordOccurredAt" filled with "2019-12-20T05:58:16+00:00"
    And I see field "lastTrackerRecordOdometer" filled with 6898981

  Scenario: I want to edit and remove vehicle odometer
    Given I signed in as "super_admin" team "admin"
    Then I want fill "model" field with 2
    Then I want fill "type" field with "Car"
    Then I want fill "vin" field with 4
    Then I want fill "fuelType" field with 1
    Then I want fill "year" field with "2000"
    And I want get client by name "client-name-0" and save id
    And I want fill teamId by saved clientId
    Then I want to create vehicle and save id
    And response code is 200
    And I see field "team/type" filled with "client"
    And I want fill device model for vehicle with name "FM3001"
    And I want fill "sn" field with "test sn"
    And I want fill "status" field with "inStock"
    And I want fill "port" field with 25
    And I want fill "imei" field with "888888888888888"
    And I want fill "phone" field with "+(375) 245535454"
    Then I want to create device for vehicle and save id
    Then I want install device for vehicle
    And I want set vehicle driver with user of current team with date "2019-05-29 08:19:38"
    Given There are following tracker payload from teltonika tracker with socket "that socket":
      | payload                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
      | 000F383838383838383838383838383838                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
      | 000000000000044f080b0000016f21e158700010647357201fe8f600ea00ee0e0056001507ef01f001c800710021fe2559302f0942388b1800564300004400000d06b30f00282a02552b0000311f3804f100006465c7000008b5100069440e0c00113c8801ee00000000000000000000016f21e16bf80010643ae5201fd45300ef00ef0d004f001507ef01f001c800710021002552302f094238a218004f4300004400000d06b30f00282a02592b0000311f3804f100006465c70000092710006944800c00113c9d01ee00000000000000000000016f21e177b00010641afe201fc80500f200ee0e0048001507ef01f001c800710021012551302f094238551800484300004400000d06b30f00282a025c2b0000311f3804f100006465c70000096910006944c20c00113ca901ee00000000000000000000016f21e17f80001064083e201fc0fd00f400ee0f003e001507ef01f001c800710021012551302f0942383518003e4300004400000d06b30f00282a025c2b0000311f3804f100006465c70000099110006944ea0c00113caf01ee00000000000000000000016f21e18750001063f9a9201fbc1b00f300ed0f002c001507ef01f001c800710021002542302f094237ee18002c4300004400000d06b30f00282a02602b0000311f3804f100006465c7000009b2100069450b0c00113cb401ee00000000000000000000016f21e18b38001063f5b0201fba5900f300ec0f0022001507ef01f001c800710021002542302f094236b01800224300004400000d06b30f00282a02602b0000311f3804f100006465c7000009bf10006945180c00113cb601ee00000000000000000000016f21e18f20001063f39b201fb99100f300e70e0012001507ef01f001c800710021002542302f0942378c1800124300004400000d06b30f00282a02602b0000311f3804f100006465c7000009c710006945200c00113cb601ee00000000000000000000016f21e19308001063f442201fb99100f200e70e0005001507ef01f001c80071002100251a302f094237ea1800054300004400000d06b30f00282a02642b0000311f3804f100006465c7000009cb10006945240c00113cb601ee00000000000000000000016f21e20838001063f678201fb9f500f300e70e0000001507ef01f001c800710021022500302f094237f61800004300004400000d06b30f00282a02822b0000311f3804f100006465c7000009cc10006945250c00113cbe01ee00000000000000000000016f21e27d68001063f678201fb9f500f300e70e0000001507ef01f001c800710021002500302f094237f61800004300004400000d06b30f00282a02a02b0000311f3804f100006465c7000009cc10006945250c00113cc701ee00000000000000000000016f21e298c0001063f678201fb9f500f300e70d0000f01507ef01f000c800710021fe2500302f094237df1800004300004400000d06b30f00282a02a72b0000311f3804f100006465c7000009cc10006945250c00113cc901ee00000000000000000b0000bc94 |
    Then I want fill "odometer" field with 6900000
    Then I want fill "occurredAt" field with "2019-12-20T06:00:00+00:00"
    Then I want to create odometer record and save id
    And response code is 200
    And I see field "odometer" filled with 6900000
    And I see field "accuracy" filled with 1019
    And I see field "occurredAt" filled with "2019-12-20T06:00:00+00:00"
    And I see field "lastTrackerRecordOccurredAt" filled with "2019-12-20T05:58:16+00:00"
    And I see field "lastTrackerRecordOdometer" filled with 6898981
    When I want to get vehicle odometer history
    And I see field "data/0/odometer" filled with 6900000
    And I see field "data/0/accuracy" filled with 1019
    And I see field "data/0/lastTrackerRecordOdometer" filled with 6898981
    Then I want fill "odometer" field with 6900100
    Then I want fill "occurredAt" field with "2019-12-20T06:01:00+00:00"
    When I want to update odometer record
    Given There are following tracker payload from teltonika tracker with socket "that socket":
      | payload                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
      | 000F383838383838383838383838383838                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
      | 0000000000000422080b0000016f21e7b94000105c6f31201e4b4a00fd01020e0018001507ef01f001c80071002100251b302d0942387a1800184300004400000d06b30f00362a03f82b0000311f3c04f100006465c700001814100069536d0c00113ed501ee00000000000000000000016f21e7bd2800105c6bf0201e4c2300fd01170e0013001507ef01f001c80071002100251b302d0942387a1800134300004400000d06b30f00362a03f82b0000311f3c04f100006465c700001814100069536d0c00113ed501ee00000000000000000000016f21e7c8e000105c6c43201e525200fa001a0e0013001507ef01f001c80071002100251b302d094238dd1800134300004400000d06b30f00362a03f82b0000311f3c04f100006465c700001826100069537f0c00113ed601ee00000000000000000000016f21e7ccc800105c7167201e558300fa002b0e001f001507ef01f001c800710021f9251b302d0942392918001f4300004400000d06b30f00362a03fc2b0000311f3c04f100006465c70000182f10006953880c00113ed601ee00000000000000000000016f21e7d49800105c7786201e5ada00fa00190e001c001507ef01f001c800710021f9251b302d0942391018001c4300004400000d06b30f00362a03fc2b0000311f3c04f100006465c700001845100069539e0c00113ed801ee00000000000000000000016f21e7d88000105c799c201e5d9500fa000e0e001c001507ef01f001c800710021fd251d302d0942389618001c4300004400000d06b30f00362a04002b0000311f3c04f100006465c70000184e10006953a70c00113ed801ee00000000000000000000016f21e7e05000105c79de201e619f00fa01620e000f001507ef01f001c800710021fd251d302d0942381218000f4300004400000d06b30f00362a04002b0000311f3c04f100006465c70000185d10006953b60c00113ed901ee00000000000000000000016f21e7e43800105c7938201e628800fa01550e0007001507ef01f001c800710021fd251d302d0942384b1800074300004400000d06b30f00362a04002b0000311f3c04f100006465c70000186210006953bb0c00113ed901ee00000000000000000000016f21e82e7000105c78d4201e62cb00fa01550d0000ef0f04ef00f001c8007100064233841800004300004400000d06b30f003604f100006465c70000186510006953be0c00113edd01ee00000000000000000000016f21e8a3a000105c78d4201e62cb00fa01550e0000000f04ef00f001c8007100064233021800004300004400000d06b30f003604f100006465c70000186510006953be0c00113edd01ee00000000000000000000016f21e8edd800105c78d4201e62cb00fa01550d0000f00f04ef00f000c8007100064232d41800004300004400000d06b30f003604f100006465c70000186510006953be0c00113edd01ee00000000000000000b00005d76                                                                                                                                                                                                                                                                                                   |
    When I want to get vehicle current odometer
    # 6902718+1119
    And I see field "odometer" filled with 6903837
    And I see field "accuracy" filled with 1119
    And I see field "occurredAt" filled with "2019-12-20T06:01:00+00:00"
    And I see field "lastTrackerRecordOccurredAt" filled with "2019-12-20T06:05:11+00:00"
    And I see field "lastTrackerRecordOdometer" filled with 6902718
    When I want to delete saved odometer record
    And response code is 204
    Then I want to get vehicle odometer history
    And I see field "total" filled with 0
    And response code is 200
    When I want to get vehicle current odometer
    And I see field "odometer" filled with 6902718
    And I see field "accuracy" filled with 0
    And I see field "occurredAt" filled with "null"
    And I see field "lastTrackerRecordOccurredAt" filled with "2019-12-20T06:05:11+00:00"
    And I see field "lastTrackerRecordOdometer" filled with 6902718

  Scenario: I want to see vehicle with corrected odometer in tracker data
    Given I signed in as "super_admin" team "admin"
    Then I want fill "model" field with 2
    Then I want fill "type" field with "Car"
    Then I want fill "vin" field with 4
    Then I want fill "fuelType" field with 1
    Then I want fill "year" field with "2000"
    And I want get client by name "client-name-0" and save id
    And I want fill teamId by saved clientId
    Then I want to create vehicle and save id
    And response code is 200
    And I see field "team/type" filled with "client"
    And I want fill device model for vehicle with name "FM3001"
    And I want fill "sn" field with "test sn"
    And I want fill "status" field with "inStock"
    And I want fill "port" field with 25
    And I want fill "imei" field with "888888888888888"
    And I want fill "phone" field with "+(375) 245535454"
    Then I want to create device for vehicle and save id
    Then I want install device for vehicle
    And I want set vehicle driver with user of current team with date "2019-05-29 08:19:38"
    Given There are following tracker payload from teltonika tracker with socket "that socket":
      | payload                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
      | 000F383838383838383838383838383838                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
      | 000000000000044f080b0000016f21e158700010647357201fe8f600ea00ee0e0056001507ef01f001c800710021fe2559302f0942388b1800564300004400000d06b30f00282a02552b0000311f3804f100006465c7000008b5100069440e0c00113c8801ee00000000000000000000016f21e16bf80010643ae5201fd45300ef00ef0d004f001507ef01f001c800710021002552302f094238a218004f4300004400000d06b30f00282a02592b0000311f3804f100006465c70000092710006944800c00113c9d01ee00000000000000000000016f21e177b00010641afe201fc80500f200ee0e0048001507ef01f001c800710021012551302f094238551800484300004400000d06b30f00282a025c2b0000311f3804f100006465c70000096910006944c20c00113ca901ee00000000000000000000016f21e17f80001064083e201fc0fd00f400ee0f003e001507ef01f001c800710021012551302f0942383518003e4300004400000d06b30f00282a025c2b0000311f3804f100006465c70000099110006944ea0c00113caf01ee00000000000000000000016f21e18750001063f9a9201fbc1b00f300ed0f002c001507ef01f001c800710021002542302f094237ee18002c4300004400000d06b30f00282a02602b0000311f3804f100006465c7000009b2100069450b0c00113cb401ee00000000000000000000016f21e18b38001063f5b0201fba5900f300ec0f0022001507ef01f001c800710021002542302f094236b01800224300004400000d06b30f00282a02602b0000311f3804f100006465c7000009bf10006945180c00113cb601ee00000000000000000000016f21e18f20001063f39b201fb99100f300e70e0012001507ef01f001c800710021002542302f0942378c1800124300004400000d06b30f00282a02602b0000311f3804f100006465c7000009c710006945200c00113cb601ee00000000000000000000016f21e19308001063f442201fb99100f200e70e0005001507ef01f001c80071002100251a302f094237ea1800054300004400000d06b30f00282a02642b0000311f3804f100006465c7000009cb10006945240c00113cb601ee00000000000000000000016f21e20838001063f678201fb9f500f300e70e0000001507ef01f001c800710021022500302f094237f61800004300004400000d06b30f00282a02822b0000311f3804f100006465c7000009cc10006945250c00113cbe01ee00000000000000000000016f21e27d68001063f678201fb9f500f300e70e0000001507ef01f001c800710021002500302f094237f61800004300004400000d06b30f00282a02a02b0000311f3804f100006465c7000009cc10006945250c00113cc701ee00000000000000000000016f21e298c0001063f678201fb9f500f300e70d0000f01507ef01f000c800710021fe2500302f094237df1800004300004400000d06b30f00282a02a72b0000311f3804f100006465c7000009cc10006945250c00113cc901ee00000000000000000b0000bc94 |
    Then I want fill "odometer" field with 6900000
    Then I want fill "occurredAt" field with "2019-12-20T05:55:00+00:00"
    Then I want to create odometer record and save id
    And response code is 200
    And I see field "odometer" filled with 6900000
    And I see field "accuracy" filled with 1019
    And I see field "occurredAt" filled with "2019-12-20T05:55:00+00:00"
    And I see field "lastTrackerRecordOccurredAt" filled with "2019-12-20T05:58:16+00:00"
    And I see field "lastTrackerRecordOdometer" filled with 6898981
    # Need to update device last tracker history dependency
    Given Elastica populate
    When I want add value to array key "fields" with "device"
    Then I want to get vehicle by saved id
    And I see field "device/trackerData/mileage" filled with "6900000"
    And I see field "device/trackerData/mileageFromTracker" filled with "6898981"
    Then response code is 200